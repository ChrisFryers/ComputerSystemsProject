# https://towardsdatascience.com/integrating-pyplot-and-pysimplegui-b68be606b960


from typing import List
import PySimpleGUI as sg
import numpy as np
import datetime as dt
import pandas as pd
import matplotlib.pyplot as plt
from matplotlib.backends.backend_tkagg import FigureCanvasTkAgg

# cyclical imports
from statsmodels.tsa.filters.hp_filter import hpfilter

# \\  -------- GET DATA -------- //

# create function importData()

def getData():

    # get data
    df = pd.read_csv(r'C:\Users\Chris\Desktop\UlsterUniversity\Final Project\PySimpleGUI\Closedf.csv', parse_dates = True, index_col = 'Date')
    df = df[['EURUSD=X', 'GBPUSD=X']]

    # specifying period
    end = dt.datetime.now()  # end date is now
    start = dt.datetime(2005, 1, 1)   # start date  
    df = df[start:end]
    # setting frequency
    df = df.asfreq('D') # changes frequency to daily
    #df.index # checks the frequency at bottom of printout
    
    # fills NaN's
    df = df.fillna(method = 'backfill')  # takes the close rows and fills in missing values back
    df = df.fillna(method = 'ffill')  # takes the close rows and fills in missing values forwards, for some markets operating at different days
    
    #returns dataframe
    return (df)

def getAssetList():
    #get list of assets from dataset
    data = getData()
    assetsList = list(data)
    return assetsList

assetsList = getAssetList()

# \\  -------- CYCLICAL ANALYSIS -------- //

def get_cyclical_analysis():
    
    # getting the data
    df = getData()

    #()  asset symbol selected from list
    asset = df[assetSelected]

    asset_cycle,asset_trend = hpfilter(asset, lamb=1600*30**4)

    return asset_cycle








# VARS CONSTS:
_VARS = {'window': False,
         'fig_agg': False,
         'pltFig': False, 

         'figg_agg_cycle': False,
         'pltFig_cycle': False
         }

# \\  -------- PYSIMPLEGUI THEME -------- //

# Theme for pyplot
plt.style.use('dark_background')

AppFont = 'Any 16'
sg.theme('black')

# \\  -------- ELEMENTS IN LAYOUT -------- //

layout = [[sg.Canvas(key='figCanvas', expand_x = True, expand_y = True), sg.Listbox( values = assetsList, size = (20, 2), enable_events = True, key = '-LISTBOX_CLICK-')],
          [sg.Canvas(key='figCanvas_Cycle'), sg.Button('Update', font=AppFont), sg.Button('Exit', font=AppFont)]]
          
# \\  -------- APPLICATION WINDOW  -------- //

_VARS['window'] = sg.Window('Such Window',
                            layout,
                            size = (1000, 500),
                            finalize=True,
                            resizable=True,
                            location=(100, 100),
                            element_justification="center",
                            background_color='black')

# \\  -------- PYSIMPLEGUI -------- //

# \\  -------- PYPLOTS -------- //

# \\  -------- MAIN -------- //

def draw_figure(canvas, figure):
    figure_canvas_agg = FigureCanvasTkAgg(figure, canvas)
    figure_canvas_agg.draw()
    figure_canvas_agg.get_tk_widget().pack(side='top', fill='both', expand=5)
    return figure_canvas_agg

def drawMainChart():
    _VARS['pltFig'] = plt.figure()
    data = getData()
    plt.plot(data['EURUSD=X'])
    plt.title('EURUSD=X')
    _VARS['fig_agg'] = draw_figure(
        _VARS['window']['figCanvas'].TKCanvas, _VARS['pltFig'])

def updateMainChart():
    _VARS['fig_agg'].get_tk_widget().forget()
    data = getData()
    # plt.cla()
    plt.clf()
    plt.plot(data[assetSelected])
    plt.title(assetSelected)
    _VARS['fig_agg'] = draw_figure(
        _VARS['window']['figCanvas'].TKCanvas, _VARS['pltFig'])


# \\  -------- CYCLICAL -------- //

def draw_figure_cyclical(canvas_cycle, figure_cycle):
    figure_canvas_agg_cycle = FigureCanvasTkAgg(figure_cycle, canvas_cycle)
    figure_canvas_agg_cycle.draw()
    figure_canvas_agg_cycle.get_tk_widget().pack(side='top', fill='both', expand=1)
    return figure_canvas_agg_cycle

def drawCycleChart():
    _VARS['pltFig_cycle'] = plt.figure()
    data = getData()
    plt.plot(data['EURUSD=X'])
    plt.title('Cyclical Forecast')
    _VARS['fig_agg_cycle'] = draw_figure_cyclical(
        _VARS['window']['figCanvas_Cycle'].TKCanvas, _VARS['pltFig_cycle'])

def updateCycleChart():
    _VARS['fig_agg_cycle'].get_tk_widget().forget()
    data = get_cyclical_analysis()
    # plt.cla()
    plt.clf()
    plt.plot(data)
    plt.title('Cyclical Forecast')
    _VARS['fig_agg_cycle'] = draw_figure_cyclical(
        _VARS['window']['figCanvas_Cycle'].TKCanvas, _VARS['pltFig_cycle'])


# \\  -------- PYPLOT -------- //

drawMainChart()
drawCycleChart()

# \\  -------- MAIN LOOP -------- //
while True:
     
    event, value = _VARS['window'].read(timeout=200)

    # if window closed or exited - break
    if event == sg.WIN_CLOSED or event == 'Exit':
        break

    # if listbox item is selected:
    if event == '-LISTBOX_CLICK-':

       # saves listbox item selected
       assetSelected = value['-LISTBOX_CLICK-']
       #calls update chart function
       updateMainChart()
       updateCycleChart()
    

_VARS['window'].close()
